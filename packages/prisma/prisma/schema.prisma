// packages/prisma/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  firstName       String
  lastName        String
  phone           String    @unique
  role            Role      @default(SEEKER)
  isVerified      Boolean   @default(false)
  otp             Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  wishlist        Wishlist[]
  
  @@index([email])
  @@index([phone])
  @@index([role])
}

model Owner {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  firstName       String
  lastName        String
  phone           String    @unique
  isVerified      Boolean   @default(false)
  otp             Int?
  planType        String?   @default("FREE")
  validity        DateTime  @default(now())
  listings        Int?      @default(1)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  properties      Property[]
  
  @@index([email])
  @@index([phone])
}

enum Role {
  SEEKER
  OWNER
  ADMIN
}

// Admin Model
model Admin {
  id              String       @id @default(uuid())
  email           String       @unique
  password        String
  firstName       String
  lastName        String
  phone           String       @unique
  role            AdminRole    @default(EMPLOYEE)
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  lastLogin       DateTime?
  
  @@index([email])
  @@index([role])
  @@index([isActive])
}

enum AdminRole {
  MAIN_ADMIN
  EMPLOYEE
}

// Property Model - Corrected
model Property {
  id                String       @id @default(uuid())
  title             String
  description       String       @db.Text
  propertyType      PropertyType
  // Listing type and marketing
  listingType       String       @default("RENT") // "RENT" or "SALE"
  type              String?      @default("RENT") // e.g., RENT or SALE (deprecated, use listingType)
  offer             String?      @default("")
  
  // Location
  address           String
  city              String
  townSector        String?
  colony            String?
  landmark          String?
  latitude          Float?
  longitude         Float?
  apiAddress        String?
  
  // Pricing - Rental
  rent              String?
  security          String?      @default("0")
  maintenance       String?      @default("0")
  negotiable        Boolean      @default(false)
  
  // Pricing - Sale (NEW)
  salePrice         String?
  pricePerSqft      String?
  
  // Property Measurements (NEW)
  carpetArea        String?
  builtUpArea       String?
  floorNumber       Int?
  
  // Property Details (NEW for Sale)
  propertyAge       String?      // New/1-5 years/5-10 years/10+ years
  facingDirection   String?      // North/South/East/West
  possession        String?      // Ready to move/Under construction
  furnishingDetails String?      @db.Text
  
  // Property Details
  bhk               Int          @default(1)
  furnished         String
  accommodation     String?      // For rental properties
  totalFloors       Int          @default(1)
  totalUnits        Int          @default(1)
  
  // Utilities
  powerBackup       String
  waterSupply       String
  parking           String
  
  // Amenities
  insideAmenities   String[]
  outsideAmenities  String[]
  
  // Preferences (mainly for rental)
  genderPreference  String?
  preferredTenants  String[]
  noticePeriod      String?
  
  // Contact
  contactName       String
  whatsappNo        String
  images            String[]
  
  // Metadata
  isAvailable       Boolean      @default(true)
  isVerified        Boolean      @default(false)
  isDraft           Boolean      @default(false)
  
  // Verification System
  verificationStatus    VerificationStatus @default(NOT_VERIFIED)
  verifiedAt            DateTime?
  verificationExpiry    DateTime?
  
  // Stats
  views             Int          @default(0)
  contactCount      Int          @default(0)
  // Expiry (for listing validity)
  expiry            DateTime?
  
  // Owner
  ownerId           String
  owner             Owner        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  contacts              Contact[]
  wishlist              Wishlist[]
  verificationRequests  VerificationRequest[]
  
  @@index([city])
  @@index([propertyType])
  @@index([listingType])
  @@index([ownerId])
  @@index([isAvailable])
  @@index([isDraft])
  @@index([createdAt])
  @@index([verificationStatus])
}

enum PropertyType {
  ROOM
  PG
  FLAT
  PLOT
  HOUSE
  VILLA
}

enum VerificationStatus {
  NOT_VERIFIED
  PENDING_PAYMENT
  PENDING_VERIFICATION
  VERIFIED
  EXPIRED
}

enum VerificationRequestStatus {
  PENDING_PAYMENT
  PAYMENT_COMPLETED
  UNDER_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

// Verification Request Model
model VerificationRequest {
  id                String                     @id @default(uuid())
  propertyId        String
  property          Property                   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  ownerId           String
  
  // Payment Details
  amount            Int                        @default(149)
  paymentStatus     String                     @default("PENDING") // PENDING, COMPLETED, FAILED
  paymentId         String?
  paymentDate       DateTime?
  
  // Request Status
  status            VerificationRequestStatus  @default(PENDING_PAYMENT)
  
  // Admin Review
  reviewedBy        String?
  reviewedAt        DateTime?
  reviewNotes       String?                    @db.Text
  
  // Verification Period
  validFrom         DateTime?
  validUntil        DateTime?
  
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  
  @@index([propertyId])
  @@index([ownerId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
}

// Contact Model - Simplified (No Visits)
model Contact {
  id            String        @id @default(uuid())
  propertyId    String
  property      Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  userName      String
  userPhone     String
  message       String?       @db.Text
  contactType   ContactType   @default(INQUIRY)
  status        ContactStatus @default(NEW)
  
  ownerDeleted  Boolean       @default(false)
  userDeleted   Boolean       @default(false)
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@index([propertyId])
  @@index([userPhone])
  @@index([createdAt])
}

enum ContactType {
  INQUIRY
  CALL_REQUEST
  WHATSAPP
}

enum ContactStatus {
  NEW
  CONTACTED
  CLOSED
}

// Wishlist Model
model Wishlist {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId  String
  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  
  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}

// OTP Model - For Mobile Verification
model TempMobileVerifyOwnerListing {
  id        String   @id @default(uuid())
  mobile    String
  otp       Int
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([mobile])
  @@index([expiresAt])
}

model TempMobileVerification {
  id        String   @id @default(uuid())
  mobile    String   @unique
  otp       Int
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([mobile])
  @@index([expiresAt])
}

model ContactUs {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  message   String   @db.Text
  phone     String
  createdAt DateTime @default(now())
}